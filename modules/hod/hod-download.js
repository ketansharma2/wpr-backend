const express = require("express");
const PDFDocument = require("pdfkit");
const supabase = require("../../config/supabase");

const router = express.Router();

// -------- DOWNLOAD HOD REPORT PDF ----------
router.post("/download", async (req, res) => {
  try {
    const {
      user_id, // HOD user_id
      view_type, // "self" or "team"
      target_user_id, // for team view: whose report to download
      start_date,
      end_date,
      task_type,
      category,
      status
    } = req.body;

    // Determine whose report to download
    const targetUserId = view_type === "self" ? user_id : target_user_id;

    if (view_type === "team" && !target_user_id) {
      return res.status(400).json({ error: "target_user_id required when downloading team reports" });
    }

    // ---------------------- VALIDATION -----------------------
    if (!targetUserId || !start_date || !end_date) {
      return res.status(400).json({ error: "target_user_id, start_date, end_date are required" });
    }

    // ---------------------- QUERY FUNCTION -------------------
    const applyFilters = (table) => {
      let q;

      if (table === "self_tasks") {
        q = supabase.from(table).select("*").eq("user_id", targetUserId);
      } else {
        q = supabase.from(table).select("*").eq("assigned_to", targetUserId);
      }

      q = q.gte("date", start_date).lte("date", end_date);

      // Task type filter only applies to self_tasks (master_tasks don't have task_type)
      if (table === "self_tasks" && task_type && task_type !== "all") q = q.eq("task_type", task_type);
      if (status && status !== "all") q = q.eq("status", status);

      return q;
    };

    // ---------------------- CATEGORY FILTERING -------------------
    let selfQuery = applyFilters("self_tasks");
    let masterQuery = applyFilters("master_tasks");

    if (category === "self") {
      masterQuery = masterQuery.limit(0); // exclude assigned tasks
    } else if (category === "assigned") {
      selfQuery = selfQuery.limit(0); // exclude self tasks
    }
    // category = "all" or undefined: include both

    // ---------------------- FETCH DATA -----------------------
    const [selfRes, masterRes] = await Promise.all([
      selfQuery,
      masterQuery
    ]);

    const selfTasks = selfRes.data || [];
    const masterTasks = masterRes.data || [];

    // ---------------------- PDF CREATION ---------------------
    const doc = new PDFDocument({ margin: 40 });

    res.setHeader("Content-Type", "application/pdf");
    res.setHeader(
      "Content-Disposition",
      `attachment; filename=${view_type}_report_${targetUserId}_${start_date}_to_${end_date}.pdf`
    );

    doc.pipe(res);

    // ---------------------- TITLE ---------------------------
    doc
      .fontSize(20)
      .text(`${view_type === "self" ? "Self" : "Team Member"} Work Report`, { align: "center" })
      .moveDown();

    doc.fontSize(12).text(`Report For: ${targetUserId}`);
    doc.text(`Report Duration: ${start_date} to ${end_date}`);
    doc.text(`Status Filter: ${status || "all"}`);
    doc.text(`Category Filter: ${category || "all"}`);
    doc.text(`Task Type Filter: ${task_type || "all"}`);
    doc.text(`Generated by HOD: ${user_id}`);
    doc.moveDown(2);

    // ---------------------- SELF TASKS -----------------------
    if (category !== "assigned") {
      doc.fontSize(16).text("Self Tasks", { underline: true }).moveDown(0.5);

      if (selfTasks.length === 0) {
        doc.fontSize(12).text("No self tasks found.").moveDown();
      } else {
        selfTasks.forEach((task, i) => {
          doc.fontSize(12).text(`${i + 1}. ${task.task_name}`);
          doc.text(`   Date: ${task.date}`);
          doc.text(`   Status: ${task.status}`);
          doc.text(`   Type: ${task.task_type}`);
          doc.text(`   Time: ${task.time} mins`);
          doc.moveDown();
        });
      }

      if (category === "all") doc.addPage();
    }

    // ---------------------- MASTER TASKS -------------------------
    if (category !== "self") {
      doc.fontSize(16).text("Assigned Tasks", { underline: true }).moveDown(0.5);

      if (masterTasks.length === 0) {
        doc.fontSize(12).text("No assigned tasks found.").moveDown();
      } else {
        masterTasks.forEach((task, i) => {
          doc.fontSize(12).text(`${i + 1}. ${task.task_name}`);
          doc.text(`   Date: ${task.date}`);
          doc.text(`   Assigned By: ${task.assigned_by}`);
          doc.text(`   Status: ${task.status}`);
          if (task.task_type) doc.text(`   Type: ${task.task_type}`);
          doc.moveDown();
        });
      }
    }

    doc.end();

  } catch (err) {
    console.log(err);
    res.status(500).json({ error: "Server Error in generating PDF" });
  }
});

module.exports = router;